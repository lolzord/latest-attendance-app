<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        /* Style the tab */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Style the buttons inside the tab */
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 17px;
        }

        /* Change background color of buttons on hover */
        .tab button:hover {
            background-color: #ddd;
        }

        /* Create an active/current tablink class */
        .tab button.active {
            background-color: #ccc;
        }

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }

        .tabcontent.active {
            display: block;
            /* Show active tab content */
        }

        .tabcontent table {
            width: 100%;
            border-collapse: collapse;
        }

        /* Style the table headers */
        .tabcontent th {
            background-color: #f1f1f1;
            text-align: left;
            padding: 8px;
        }

        /* Style the table cells */
        .tabcontent td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        /* Style the table rows on hover */
        .tabcontent tr:hover {
            background-color: #ddd;
        }
    </style>
</head>
<a href="{{ url_for('logout') }}">Logout</a>

<body>

    <div class="tab">
        {% if show_tabs %}
        <button class="tablinks" onclick="openTab(event, 'Students')">Students</button>
        <!-- <button class="tablinks" onclick="openTab(event, 'Timetable'); loadTimetable();">Timetable</button> -->
        <button class="tablinks" onclick="openTab(event, 'RegisterSubject')">Register Subject</button>
        {% endif %}
        <button class="tablinks" onclick="openTab(event, 'Attendance')">Attendance</button>
        <button class="tablinks" onclick="openTab(event, 'TakeAttendance')">Take Attendance</button>
    </div>

    <div id="Students" class="tabcontent">
        <h3>Students</h3>
        <input type="text" id="studentsSearch" onkeyup="studentsSearch()" placeholder="Search for names..">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Card ID</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="studentsTableBody">
                {% for record in employees %}
                <tr>
                    <td>{{ record[0] }}</td>
                    <td>{{ record[1] }}</td>
                    <td>{{ record[2] }}</td>
                    <td>
                        <form action="/register_card" method="post">
                            <input type="hidden" name="email" value="{{ record[1] }}">
                            <input type="text" name="card_id" placeholder="Enter Card ID">
                            <input type="submit" value="Register Card">
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="Attendance" class="tabcontent">
        <h3>Attendance</h3>
        <input type="text" id="attendanceSearch" placeholder="Search for names..">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>In Time</th>
                    <th>Out Time</th>
                    <th>Working Hours</th>
                    <th>Subject</th> <!-- Add a new column for the subject -->
                </tr>
            </thead>
            <tbody id="attendanceTableBody"> <!-- Add the ID here -->
                {% for record in attendance_records %}
                <tr>
                    <td>{{ record[0] }}</td>
                    <td>{{ record[1] }}</td>
                    <td>{{ record[2] }}</td>
                    <td>{{ record[3] }}</td>
                    <td>{{ record[4] }}</td> <!-- Add a new cell for the subject -->
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    <div id="TakeAttendance" class="tabcontent">
        <h3>Take Attendance</h3>
        <form id="attendanceForm" method="GET" action="">
            <!-- <label for="subject">Select Subject:</label>
            <select name="subject" id="subject">
                {% for subject in subjects %}
                <option value="{{ subject }}">{{ subject }}</option>
                {% endfor %}
            </select> -->
            <input type="hidden" id="card_id" name="id"> <!-- Hidden field for the card_id -->
            <input type="button" value="Record Attendance" onclick="submitForm()">
        </form>
    </div>

    <div id="RegisterSubject" class="tabcontent">
        <form method="POST" action="/register_subject">
            <label for="start_time">Start Time:</label><br>
            <input type="time" id="start_time" name="start_time"><br>
            <label for="end_time">End Time:</label><br>
            <input type="time" id="end_time" name="end_time"><br>
            <label for="subject">Subject:</label><br>
            <input type="text" id="subject" name="subject"><br>
            <input type="submit" value="Register Subject">
        </form>
        <form action="/reset_timetable" method="post">
            <button type="submit">Reset Timetable</button>
        </form>
        <table>
            <tr>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Subject</th>
            </tr>
            {% for subject in timetable %}
            <tr>
                <td>{{ subject.start_time }}</td>
                <td>{{ subject.end_time }}</td>
                <td>{{ subject.subject }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
        </table>
    </div>
    <!-- <div id="Timetable" class="tabcontent">
        <h3>Timetable</h3>
        <form id="update-form" action="/update_timetable" method="post">
            <label for="start_time">Start Time:</label><br>
            <input type="time" id="start_time" name="start_time"><br>
            <label for="end_time">End Time:</label><br>
            <input type="time" id="end_time" name="end_time"><br>
            <label for="subject">Subject:</label><br>
            <input type="text" id="subject" name="subject"><br>
            <input type="hidden" id="slot_id" name="slot_id">
            <input type="submit" value="Update Timetable">
        </form>
        <h2>Current Timetable</h2>
        <table>
            <tr>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Subject</th>
                <th>Actions</th>
            </tr>
            {% for slot in timetable %}
            <td>{{ slot.start_time }}</td>
            <td>{{ slot.end_time }}</td>
            <td>{{ slot.subject }}</td>
            <td>
                <button class="update-button">Update</button>
            </td>
            </tr>
            {% endfor %}
        </table>
    </div> -->

    <!-- Other HTML code... -->

    <script>

        document.querySelector('table').addEventListener('click', function (event) {
            if (event.target.matches('.update-button')) {
                // Get the row that the button was clicked in
                var row = event.target.parentElement.parentElement;

                // Get the slot ID from the row's data attributes
                var slotId = row.getAttribute('data-slot-id');

                // Get the start time, end time, and subject from the row
                var startTime = row.children[0].textContent;
                var endTime = row.children[1].textContent;
                var subject = row.children[2].textContent;

                // Populate the form with the slot's current data
                document.getElementById('start_time').value = startTime;
                document.getElementById('end_time').value = endTime;
                document.getElementById('subject').value = subject;
                document.getElementById('slot_id').value = slotId;

                // Show the form
                var form = document.getElementById('update-form');
                form.style.display = 'block';
            }
        });

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();

        // Add the AJAX call here
        $(document).ready(function () {
            $.ajax({
                url: '/api/employees', // replace with your API endpoint
                method: 'GET',
                success: function (data) {
                    var tbody = $('#studentsTableBody');
                    tbody.empty();
                    data.employees.forEach(function (employee, index) {
                        var row = $('<tr>');
                        row.append($('<td>').text(employee.name));
                        row.append($('<td>').text(employee.email));
                        row.append($('<td>').html('<form action="/register_card" method="post"><input type="text" name="id" id="cardId' + (index + 1) + '" placeholder="Enter Card ID"><input type="hidden" name="email" value="' + employee.email + '"><button type="submit">Register Card ID</button></form>'));
                        tbody.append(row);
                    });
                }
            });


            // fetch('/get_timetable')
            //     .then(response => response.json())
            //     .then(data => {
            //         console.log(data);  // data is the timetable

            //         // Access the div where you want to display the timetable
            //         var timetableDiv = document.getElementById('timetable');

            //         // Convert the timetable data to a string or HTML as per your needs
            //         // Here, I'm assuming that the timetable data is an array of strings
            //         var timetableHtml = data.map(item => `<p>${item}</p>`).join('');

            //         // Set the innerHTML of the timetable div to the timetableHtml
            //         timetableDiv.innerHTML = timetableHtml;
            //     })
            //     .catch(error => console.error('Error:', error));
        });

        function studentsSearch() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("studentsSearch");
            filter = input.value.toUpperCase();
            table = document.getElementById("studentsTableBody");
            tr = table.getElementsByTagName("tr");
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        function attendanceSearch() {
            var input, filter, table, tr, td, i, txtValue;
            input = document.getElementById("attendanceSearch"); // replace with your attendance search input id
            filter = input.value.toUpperCase();
            table = document.getElementById("attendanceTableBody"); // replace with your attendance table body id
            tr = table.getElementsByTagName("tr");
            for (i = 0; i < tr.length; i++) {
                td = tr[i].getElementsByTagName("td")[0];
                if (td) {
                    txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        function takeAttendance() {
            var subject = document.getElementById('subjectSelect').value;
            fetch('/get_subjects') // replace with your server-side route
                .then(response => response.json())
                .then(subjects => {
                    if (subjects.includes(subject)) {
                        window.location.href = 'http://127.0.0.1:5000/attendance?subject=' + encodeURIComponent(subject);
                    } else {
                        alert('Invalid subject');
                    }
                });
        }

        document.getElementById("defaultOpen").click();

        // Add the AJAX call here
        document.getElementById('subject').addEventListener('change', function (event) {
            var subject = event.target.value;
            sessionStorage.setItem('subject', subject); // Save subject in session storage
        });

        var cardSwiped = false;



        // Assuming 'onCardSwipe' is a function that is called when the RFID card is swiped
        function onCardSwipe(card_id) {
            // Update the card_id field with the swiped card's ID
            document.getElementById('card_id').value = card_id;

            // Set cardSwiped to true
            cardSwiped = true;
        }

        function submitForm() {
            // Check if the "Take Attendance" tab is active
            if (document.getElementById('TakeAttendance').style.display !== 'none') {
                var subject = document.getElementById('subject').value;
                // Store the subject in sessionStorage
                // sessionStorage.setItem('subject', subject);
                alert("Subject selected. Please swipe your card now.");
            } else {
                alert("Please switch to the 'Take Attendance' tab to record attendance.");
            }
        }

        function onCardSwipe(card_id) {
            // Retrieve the subject from sessionStorage
            var subject = sessionStorage.getItem('subject');

            // Redirect to the /record_attendance route with the subject and card_id in the URL
            window.location.href = '/record_attendance?subject=' + encodeURIComponent(subject) + '&id=' + encodeURIComponent(card_id);
        }
        document.getElementById('card_id').addEventListener('change', function (event) {
            event.preventDefault(); // Prevent form from submitting immediately
            var cardId = event.target.value;
            var subject = sessionStorage.getItem('subject'); // Retrieve subject from session storage
            // Only send data to server if both cardId and subject have values
            if (cardId && subject) {
                fetch('http://192.168.0.179:5000/record_attendance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        card_id: cardId,
                        subject: subject
                    }),
                    credentials: 'include' // Ensures cookies (session) are sent
                })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        window.location.href = `http://localhost:5000/record_attendance?subject=${subject}&id=${cardId}`;
                    })
                    .catch(error => console.error('Error:', error));
            }
        });

        // fetch('/get_timetable')
        //     .then(response => response.json())
        //     .then(data => {
        //         console.log(data);  // data is the timetable
        //         // Access the div where you want to display the timetable
        //         var timetableDiv = document.getElementById('timetable');
        //         // Convert the timetable data to a string or HTML as per your needs
        //         // Here, I'm assuming that the timetable data is an array of objects with 'start_time', 'end_time', and 'subject' properties
        //         var timetableHtml = data.map(item => `<p>${item.start_time} - ${item.end_time}: ${item.subject}</p>`).join('');
        //         // Set the innerHTML of the timetable div to the timetableHtml
        //         timetableDiv.innerHTML = timetableHtml;
        //     })
        //     .catch(error => console.error('Error:', error));

        // function loadTimetable() {
        //     fetch('/get_timetable')
        //         .then(response => response.json())
        //         .then(data => {
        //             console.log(data);  // data is the timetable
        //             // Access the div where you want to display the timetable
        //             var timetableDiv = document.getElementById('timetable');
        //             // Convert the timetable data to a string or HTML as per your needs
        //             // Here, I'm assuming that the timetable data is an array of objects with 'start_time', 'end_time', and 'subject' properties
        //             var timetableHtml = data.map(item => `<p>${item.start_time} - ${item.end_time}: ${item.subject}</p>`).join('');
        //             // Set the innerHTML of the timetable div to the timetableHtml
        //             timetableDiv.innerHTML = timetableHtml;
        //         })
        //         .catch(error => console.error('Error:', error));
        // }

        // window.onload = loadTimetable;

        // var email = "{{ email }}"; // Get the email from the server-side code
        // var role = email === "izzat@gmail.com" ? "admin" : "user";

        // window.onload = function () {
        //     if (role !== 'admin') {
        //         // If the user is not an admin, hide the admin-only tabs
        //         document.querySelector('.tablinks[onclick*="Students"]').style.display = 'none';
        //         document.querySelector('.tablinks[onclick*="Timetable"]').style.display = 'none';
        //     }
        // };

        // $(document).ready(function () {
        //     $('#update-form').on('submit', function (e) {
        //         e.preventDefault();

        //         $.ajax({
        //             url: $(this).attr('action'),
        //             method: $(this).attr('method'),
        //             data: $(this).serialize(),
        //             success: function (response) {
        //                 if (response.message === 'Timetable updated successfully') {
        //                     $.ajax({
        //                         url: '/get_timetable',
        //                         method: 'GET',
        //                         success: function (response) {
        //                             var timetable = response;
        //                             var table = $('table');
        //                             table.find('tr:gt(0)').remove(); // Remove all rows except the first one

        //                             // Add the updated timetable to the table
        //                             $.each(timetable, function (i, slot) {
        //                                 table.append('<tr data-slot-id="' + slot.id + '" data-employee-id="' + slot.employee_id + '"><td>' + slot.start_time + '</td><td>' + slot.end_time + '</td><td>' + slot.subject + '</td><td><button class="update-button">Update</button></td></tr>');
        //                             });
        //                         }
        //                     });
        //                 }
        //             }
        //         });
        //     });
        // });

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none"; // Hide all tab content
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", ""); // Remove "active" from all tabs
            }
            document.getElementById(tabName).style.display = "block"; // Show clicked tab content
            evt.currentTarget.className += " active"; // Add "active" to clicked tab
        }

    </script>



</body>

</html>